/*
@title: Mancala
@author: Lenochodik
@tags: ['strategy', 'classic', 'multiplayer', 'logic']
@addedOn: 2024-00-00
*/

// = Types =========================================
const pit = "p"
const storeUp = "1"
const storeDown = "2"
const half1 = "3"
const half2 = "4"
const nothing = "5"

const handUp = "q"
const handDown = "w"
const pitSelected = "e"
const tile4 = "r"
const tile5 = "t"
const tile6 = "y"
const tile7 = "u"
const tile8 = "i"
const tile9 = "o"
const tile10 = "a"

const num0_R = "A"
const num1_R = "B"
const num2_R = "C"
const num3_R = "D"
const num4_R = "E"
const num5_R = "F"
const num6_R = "G"
const num7_R = "H"
const num8_R = "I"
const num9_R = "J"

const num0_L = "K"
const num1_L = "L"
const num2_L = "M"
const num3_L = "N"
const num4_L = "O"
const num5_L = "P"
const num6_L = "Q"
const num7_L = "R"
const num8_L = "S"
const num9_L = "T"
// =================================================

// = Legends, solids, pushables ====================
setLegend(
  // Custom font
  // - right
  [num0_R, bitmap`
................
................
................
................
..........666...
.........6...6..
.........6...6..
.........6...6..
.........6...6..
.........6...6..
.........6...6..
..........666...
................
................
................
................`],
  [num1_R, bitmap`
................
................
................
................
...........6....
..........66....
.........6.6....
...........6....
...........6....
...........6....
...........6....
.........66666..
................
................
................
................`],
  [num2_R, bitmap`
................
................
................
................
..........66....
.........6..6...
............6...
............6...
...........6....
..........6.....
.........6......
.........6666...
................
................
................
................`],
  [num3_R, bitmap`
................
................
................
................
..........66....
.........6..6...
............6...
..........66....
............6...
............6...
.........6..6...
..........66....
................
................
................
................`],
  [num4_R, bitmap`
................
................
................
................
...........6....
..........66....
.........6.6....
.........6.6....
.........6666...
...........6....
...........6....
...........6....
................
................
................
................`],
  [num5_R, bitmap`
................
................
................
................
.........6666...
.........6......
.........6......
.........666....
............6...
............6...
.........6..6...
..........66....
................
................
................
................`],
  [num6_R, bitmap`
................
................
................
................
..........66....
.........6..6...
.........6......
.........6......
.........666....
.........6..6...
.........6..6...
..........66....
................
................
................
................`],
  [num7_R, bitmap`
................
................
................
................
.........6666...
.........6..6...
............6...
...........6....
...........6....
..........6.....
..........6.....
..........6.....
................
................
................
................`],
  [num8_R, bitmap`
................
................
................
................
..........666...
.........6...6..
.........6...6..
..........666...
.........6...6..
.........6...6..
.........6...6..
..........666...
................
................
................
................`],
  [num9_R, bitmap`
................
................
................
................
..........66....
.........6..6...
.........6..6...
..........666...
............6...
............6...
.........6..6...
..........66....
................
................
................
................`],
  // - left
  [num0_L, bitmap`
................
................
................
................
...666..........
..6...6.........
..6...6.........
..6...6.........
..6...6.........
..6...6.........
..6...6.........
...666..........
................
................
................
................`],
  [num1_L, bitmap`
................
................
................
................
....6...........
...66...........
..6.6...........
....6...........
....6...........
....6...........
....6...........
..66666.........
................
................
................
................`],
  [num2_L, bitmap`
................
................
................
................
....66..........
...6..6.........
......6.........
......6.........
.....6..........
....6...........
...6............
...6666.........
................
................
................
................`],
  [num3_L, bitmap`
................
................
................
................
....66..........
...6..6.........
......6.........
....66..........
......6.........
......6.........
...6..6.........
....66..........
................
................
................
................`],
  [num4_L, bitmap`
................
................
................
................
.....6..........
....66..........
...6.6..........
...6.6..........
...6666.........
.....6..........
.....6..........
.....6..........
................
................
................
................`],
  [num5_L, bitmap`
................
................
................
................
...6666.........
...6............
...6............
...666..........
......6.........
......6.........
...6..6.........
....66..........
................
................
................
................`],
  [num6_L, bitmap`
................
................
................
................
....66..........
...6..6.........
...6............
...6............
...666..........
...6..6.........
...6..6.........
....66..........
................
................
................
................`],
  [num7_L, bitmap`
................
................
................
................
...6666.........
...6..6.........
......6.........
.....6..........
.....6..........
....6...........
....6...........
....6...........
................
................
................
................`],
  [num8_L, bitmap`
................
................
................
................
...666..........
..6...6.........
..6...6.........
...666..........
..6...6.........
..6...6.........
..6...6.........
...666..........
................
................
................
................`],
  [num9_L, bitmap`
................
................
................
................
....66..........
...6..6.........
...6..6.........
....666.........
......6.........
......6.........
...6..6.........
....66..........
................
................
................
................`],
  // Basics
  [pit, bitmap`
....11111122....
...1000000002...
..100000000002..
.10000000000001.
1000000000000001
1000000L10000002
100000LLL1000002
10000LLLLL100001
10000LLLLL100001
100000LLLL000001
1000000LL0000001
1000000000000001
.10000000000001.
..100000000001..
...1000000001...
....11111111....`],
  [pitSelected, bitmap`
....DDDDDD44....
...D000000004...
..D00000000004..
.D000000000000D.
D00000000000000D
D000000LD0000004
D00000LLLD000004
D0000LLLLLD0000D
D0000LLLLLD0000D
D00000LLLL00000D
D000000LL000000D
D00000000000000D
.D000000000000D.
..D0000000000D..
...D00000000D...
....DDDDDDDD....`],
  [storeUp, bitmap`
....11111111....
...1000000002...
..100000000002..
.10000000000002.
1000000000000002
10000LLLLLL00002
1000LLLLLLLL0002
100LLLLLLLLLL001
100LLLLLLLLLL001
100LLLLLLLLLL001
100LLLLLLLLLL001
100LLLLLLLLLL001
100LLLLLLLL1L001
100LLLLLLLLLL001
100LLLLLLLL1L001
100LLLLLLLL1L001`],
  [storeDown, bitmap`
100LLLLLLLL1L002
100LLLLLLLL1L001
100LLLLLLLL1L002
100LLLLLLLL1L002
100LLLLLLLL1L001
100LLLLLLLLLL001
100LLLLLLLL1L001
100LLLLLLLL1L001
100LLLLLLL1LL001
1000LLLL11LL0001
10000LLLLLL00001
1000000000000001
.10000000000001.
..100000000001..
...1000000001...
....11111111....`],
  [half1, bitmap`
0000000000000000
1111111111111111
1111111111211222
................
................
................
................
................
................
................
................
................
................
................
................
................`],
  [half2, bitmap`
................
................
................
................
................
................
................
................
................
................
................
................
................
1111111111222121
1111111111111111
0000000000000000`],
  [nothing, bitmap`
99C99999999CCC99
C9CC99CCCC9C99CC
CCCCC99CCC9C9CCC
C9CCCC9CC9CC9CCC
C9C9999CC9CC9999
9CC9CCCCC9CCCCC9
CCC9CC9999999CCC
999999CC99C999CC
CC9CCCCCC99CC999
CC9CCC999C9CCC9C
C9999C9C99C999CC
CCCC9C9CC99CC99C
CC999C9CCC9CC99C
C99CCC9CCC9CC9CC
C9CCCC9CCC9999CC
CC99999CCCCCCCC9`],
  // Tiles
  [handUp, bitmap`
.....00.........
....0220........
....0220........
....022000......
....0220120.....
....022012000...
....02201201100.
000.0220L2012010
0110022L120L20L0
021L022222L120L0
002L021212222L20
.001L22121212220
..0012222212120.
...012222222210.
....0L1111111L0.
....0LLLLLLLL0..`],
  [handDown, bitmap`
..0LLLLLLLL0....
.0L1111111L0....
.012222222210...
.0212122222100..
02221212122L100.
02L222212120L200
0L021L222220L120
0L02L021L2200110
0102102L0220.000
.00110210220....
...000210220....
.....0210220....
......000220....
........0220....
........0220....
.........00.....`],
  [tile4, bitmap`
11111...........
1111122.........
LLLLL2222.......
LLLLLLL221......
LLLLLLLLL11.....
LLLLLLLLLL21....
LLLLLLLLLLL11...
LLLLLLLLLLLL11..
LLLLLLLLLLLLL11.
LLLLLLLLLLLLL11.
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11`],
  [tile5, bitmap`
LLLLLLLLLLLLLLL1
LLLLLLLLLLLLLLL1
LLLLLLLLLLLLLLL1
LLLLLLLLLLLLLLL1
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLL11.
LLLLLLLLLLLLL11.
LLLLLLLLLLLL11..
LLLLLLLLLLL11...
LLLLLLLLLL11....
LLLLLLLLL11.....
LLLLLLL111......
LLLLL1111.......
1111111.........
11111...........`],
  [tile6, bitmap`
1LLLLLLLLLLLLLLL
1LLLLLLLLLLLLLLL
1LLLLLLLLLLLLLLL
1LLLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
.11LLLLLLLLLLLLL
.11LLLLLLLLLLLLL
..11LLLLLLLLLLLL
...11LLLLLLLLLLL
....11LLLLLLLLLL
.....11LLLLLLLLL
......111LLLLLLL
.......1111LLLLL
.........1111111
...........11111`],
  [tile7, bitmap`
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL
11LLLLLLLLLLLLLL`],
  [tile8, bitmap`
LLLLLLLLLLLLLL22
LLLLLLLLLLLLLL22
LLLLLLLLLLLLLL22
LLLLLLLLLLLLLL22
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL22
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11
LLLLLLLLLLLLLL11`],
  [tile9, bitmap`
....33333333....
...3333333333...
..333333333333..
.33333333333333.
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
.33333333333333.
..333333333333..
...3333333333...
....33333333....`],
  [tile10, bitmap`
................
................
................
................
................
................
................
................
................
................
................
................
................
................
................
................`],
)
// =================================================

// = Levels ========================================
let level = 0
const levels = [
  map`
..........
..........
..pppppp..
.14444441.
.23333332.
..pppppp..
..........
..........`
]
setMap(levels[level])

setBackground(nothing)
// =================================================


// = Melodies, sounds ==============================
const soundMoveHand = tune`
300: B4^300,
9300`
const soundMoveHandOutOfBounds = tune`
300: A4^300 + F4~300 + G4~300 + B4~300 + C5~300,
9300`
const soundPutPieceOdd = tune`
300: G4~300 + B4/300,
9300`
const soundPutPieceEven = tune`
300: A4~300 + C5/300,
9300`
const soundCollectOpponentsPieces = tune`
150: B4^150,
150: C5^150,
150: D5/150,
150: B4^150,
150: D5/150,
4050`
const soundPlayAgain = tune`
166.66666666666666: B4^166.66666666666666,
166.66666666666666: C5^166.66666666666666,
166.66666666666666: D5^166.66666666666666,
166.66666666666666: E5^166.66666666666666,
166.66666666666666: F5^166.66666666666666,
166.66666666666666: G5^166.66666666666666,
166.66666666666666: A5^166.66666666666666,
166.66666666666666: B5^166.66666666666666,
4000`
// =================================================

// = Functions =====================================
const customFont = [
  [num0_R, num1_R, num2_R, num3_R, num4_R, num5_R, num6_R, num7_R, num8_R, num9_R],
  [num0_L, num1_L, num2_L, num3_L, num4_L, num5_L, num6_L, num7_L, num8_L, num9_L],
]

function addCustomText(str, x, y, bgSprite = pit) {
  clearTile(x, y)
  addSprite(x, y, bgSprite)
  const strReversed = str.split('').reverse().join('')
  for(let i = 0; i < str.length && i < customFont.length; i++)
    addSprite(x, y, customFont[i][parseInt(strReversed.charAt(i), 10)])
}
// =================================================


// = Mancala code ==================================
const halfBoardSize = 6
const initialPieces = 5
const storesCount = 2
const storesIndexes = [halfBoardSize, 2 * halfBoardSize + 1]
const game = {
  board: Array(halfBoardSize * 2 + storesCount)
    .fill(initialPieces),
  // For debug purposes:
  // board: Array.from({ length: halfBoardSize * 2 + storesCount }, (_, index) => index),
  currentPlayer: 0,
}
game.board[storesIndexes[0]] = 0
game.board[storesIndexes[1]] = 0

const boardTopY = 2
const boardBotY = 5
const boardX = 2

const storeLeftX = 1
const storeRightX = 8
const storeY = 4

function printBoardText() {
  // Bottom half
  for (let i = 0; i < halfBoardSize; i++)
    addCustomText(game.board[i].toString(), boardX + i, boardBotY)

  // Top half
  for (let i = 0; i < halfBoardSize; i++)
    addCustomText(game.board[game.board.length - 2 - i].toString(), boardX + i, boardTopY)

  // Left store
  addCustomText(game.board[storesIndexes[1]].toString(), storeLeftX, storeY, storeDown)

  // Right store
  addCustomText(game.board[storesIndexes[0]].toString(), storeRightX, storeY, storeDown)
}
printBoardText()


const handMinX = boardX
const handMaxX = boardX + halfBoardSize - 1
let objectHand = null

function prepareHandForSelection() {
  const isBot = game.currentPlayer === 0
  
  objectHand?.remove()
  isBot ?
    addSprite(handMinX, boardBotY + 1, handUp) :
    addSprite(handMaxX, boardTopY - 1, handDown)
  objectHand = isBot ? getFirst(handUp) : getFirst(handDown)
}
prepareHandForSelection()

function handCoordsToBoardCoords() {
  const isBot = game.currentPlayer === 0

  if (isBot)
    return objectHand.x - handMinX
  else
    return handMaxX - objectHand.x + (halfBoardSize + 1)
}

onInput("a", () => {
  if(objectHand.x <= handMinX)
    playTune(soundMoveHandOutOfBounds)
  else {
    playTune(soundMoveHand)
    objectHand.x -= 1
  }
})

onInput("d", () => {
  if(objectHand.x >= handMaxX)
    playTune(soundMoveHandOutOfBounds)
  else {
    playTune(soundMoveHand)
    objectHand.x += 1
  }
})

onInput("k", () => {
  const index = handCoordsToBoardCoords()
  game.board[index] = 0
  printBoardText()

  playTune(soundPutPieceOdd)

  // TODO: make loop to spread the pieces
})
